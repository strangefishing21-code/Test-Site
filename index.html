<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kepulau - Penyewaan Perahu</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />

  <style>
    body { font-family: "Poppins", sans-serif; }
  </style>
</head>

<body class="bg-gradient-to-b from-blue-100 via-cyan-100 to-yellow-100 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-gradient-to-r from-cyan-600 via-blue-600 to-teal-600 text-white shadow-md">
    <div class="container mx-auto px-6 py-4 flex flex-col md:flex-row items-center justify-between">
      <h1 class="text-3xl font-bold tracking-wide">Kepulau</h1>
      <nav class="mt-3 md:mt-0 flex space-x-6 text-lg font-semibold">
        <a href="#boats" class="hover:text-yellow-300 transition">Perahu</a>
        <a href="#upload" class="hover:text-yellow-300 transition">Unggah Perahu</a>
      </nav>
    </div>
  </header>

  <main class="flex-grow container mx-auto px-6 py-10">
    <section class="text-center mb-12">
      <h2 class="text-4xl font-extrabold text-cyan-800 mb-4">Jelajahi Pulau Bersama Kami</h2>
      <p class="text-lg text-cyan-700">Temukan kapal terbaik dan kapten terpercaya untuk perjalanan Anda.</p>
    </section>

    <!-- Upload Form -->
    <section id="upload" class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-8 mb-20">
      <h3 class="text-2xl font-bold text-cyan-800 mb-6 text-center">Kapten, Unggah Perahu Anda</h3>
      <form id="boatUploadForm" class="space-y-6" enctype="multipart/form-data">
        <div>
          <label for="boatName" class="block text-cyan-900 font-semibold mb-1">Nama Perahu</label>
          <input id="boatName" name="boatName" type="text" required placeholder="Masukkan nama perahu Anda"
                 class="w-full border border-cyan-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-cyan-500" />
        </div>

        <div>
          <label for="boatImage" class="block text-cyan-900 font-semibold mb-1">Gambar Perahu (PNG/JPG)</label>
          <input id="boatImage" name="boatImage" type="file" required accept=".png,.jpg,.jpeg"
                 class="w-full border border-cyan-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-cyan-500" />
        </div>

        <div>
          <label class="block text-cyan-900 font-semibold mb-1">Tujuan & Harga</label>
          <div id="destinationsContainer" class="space-y-3">
            <div class="destination-row grid grid-cols-2 gap-3">
              <input type="text" class="destination-name border rounded-md px-3 py-2" placeholder="Nama tujuan" required />
              <input type="number" class="destination-price border rounded-md px-3 py-2" placeholder="Harga (Rp)" min="0" required />
            </div>
          </div>
          <button type="button" id="addDestinationBtn"
                  class="mt-3 inline-flex items-center px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-md font-semibold transition">
            <i class="fas fa-plus mr-2"></i> Tambah Tujuan
          </button>
        </div>

        <div>
          <label for="maxCapacity" class="block text-cyan-900 font-semibold mb-1">Kapasitas Maksimum</label>
          <input id="maxCapacity" name="maxCapacity" type="number" required min="1" placeholder="Contoh: 10"
                 class="w-full border border-cyan-300 rounded-md px-3 py-2" />
        </div>

        <div>
          <label for="contactInfo" class="block text-cyan-900 font-semibold mb-1">Info Kontak (Nomor WhatsApp)</label>
          <input id="contactInfo" name="contactInfo" type="tel" required pattern="^\+?[0-9]{7,15}$" placeholder="+6281234567890"
                 class="w-full border border-cyan-300 rounded-md px-3 py-2" />
        </div>

        <div class="text-center">
          <button id="submitBtn" type="submit"
                  class="bg-yellow-400 hover:bg-yellow-500 text-cyan-900 font-bold px-6 py-3 rounded-md shadow-md transition">
            <i class="fas fa-upload mr-2"></i> Unggah Perahu
          </button>
        </div>
      </form>
    </section>

    <!-- Available Boats -->
    <section id="boats">
      <h3 class="text-3xl font-bold text-cyan-800 mb-8 text-center">Perahu Tersedia</h3>
      <div id="boatsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8"></div>
    </section>
  </main>

  <footer class="bg-cyan-700 text-cyan-100 py-6 mt-20 text-center">
    <p>&copy; 2025 Kepulau - Jelajahi Pulau Bersama Kami</p>
  </footer>

  <!-- Popup Form -->
  <div id="popupForm" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg p-6 w-96 relative">
      <h3 class="text-xl font-bold text-cyan-800 mb-4">Isi Data Anda</h3>
      <form id="customerForm" class="space-y-4">
        <input type="email" name="email" placeholder="Email (opsional)" class="w-full border rounded-md px-3 py-2" />
        <input type="tel" name="phone" placeholder="Nomor HP (opsional)" class="w-full border rounded-md px-3 py-2" />
        <label class="flex items-start space-x-2">
          <input type="checkbox" name="agreement" class="mt-1" />
          <span class="text-sm">Saya setuju penggunaan informasi pribadi saya untuk menerima informasi/promo dari Kepulau</span>
        </label>
        <div class="flex justify-end space-x-3">
          <button type="button" id="skipBtn" class="px-4 py-2 bg-gray-300 rounded-md">Lewati</button>
          <button type="submit" class="px-4 py-2 bg-cyan-600 text-white rounded-md">Lanjutkan</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- App Script -->
  <script>
    const supabase = window.supabase.createClient(
      "https://asoybmopsysyghiozxie.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFzb3libW9wc3lzeWdoaW96eGllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczMDY4MzEsImV4cCI6MjA3Mjg4MjgzMX0.rCZQd4OnPjWYqunZDOM8JwwPcA7O1m5JAc0l0-3m8TY"
    );

    const addDestinationBtn = document.getElementById("addDestinationBtn");
    const destinationsContainer = document.getElementById("destinationsContainer");
    const boatUploadForm = document.getElementById("boatUploadForm");
    const boatsContainer = document.getElementById("boatsContainer");
    const submitBtn = document.getElementById("submitBtn");

    // Add destination row
    addDestinationBtn.addEventListener("click", () => {
      const row = document.createElement("div");
      row.className = "destination-row grid grid-cols-2 gap-3";
      row.innerHTML = `
        <input type="text" class="destination-name border rounded-md px-3 py-2" placeholder="Nama tujuan" required />
        <input type="number" class="destination-price border rounded-md px-3 py-2" placeholder="Harga (Rp)" min="0" required />
      `;
      destinationsContainer.appendChild(row);
    });

    // Submit boat
    boatUploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      submitBtn.disabled = true;

      const boatName = document.getElementById("boatName").value.trim();
      const boatImageFile = document.getElementById("boatImage").files[0];
      const maxCapacity = parseInt(document.getElementById("maxCapacity").value);
      const contactInfo = document.getElementById("contactInfo").value.trim();

      const destinations = [];
      document.querySelectorAll(".destination-row").forEach(row => {
        const name = row.querySelector(".destination-name").value.trim();
        const price = row.querySelector(".destination-price").value.trim();
        if (name && price) destinations.push({ name, price });
      });

      // Upload image
      const fileExt = boatImageFile.name.split(".").pop();
      const filePath = `boats/${Date.now()}.${fileExt}`;
      const { error: uploadError } = await supabase.storage.from("boat-images").upload(filePath, boatImageFile);
      if (uploadError) { alert("Upload gagal: " + uploadError.message); submitBtn.disabled = false; return; }

      const { data: publicUrlData } = supabase.storage.from("boat-images").getPublicUrl(filePath);

      const { error: insertError } = await supabase.from("boats").insert([{
        boat_name: boatName,
        boat_image: publicUrlData.publicUrl,
        destinations,
        contact_info: contactInfo,
        max_capacity: maxCapacity
      }]);

      if (insertError) { alert("Simpan gagal: " + insertError.message); submitBtn.disabled = false; return; }

      alert("Perahu berhasil diunggah!");
      boatUploadForm.reset();
      loadBoats();
      submitBtn.disabled = false;
    });

    // Load boats
    async function loadBoats() {
      boatsContainer.innerHTML = "";
      const { data: boats, error } = await supabase.from("boats").select("*");

      if (error || !boats) {
        boatsContainer.innerHTML = "<p class='text-red-600'>Gagal memuat data.</p>";
        return;
      }

      boats.forEach(boat => {
        if (typeof boat.destinations === "string") {
          try { boat.destinations = JSON.parse(boat.destinations); }
          catch { boat.destinations = []; }
        }

        const boatCard = document.createElement("div");
        boatCard.className = "bg-white rounded-xl shadow-md overflow-hidden flex flex-col relative";

        boatCard.innerHTML = `
          <img src="${boat.boat_image}" alt="Perahu ${boat.boat_name}" class="w-full h-48 object-cover" />
          <div class="p-5 flex flex-col flex-grow">
            <h4 class="text-xl font-bold text-cyan-800 mb-3">${boat.boat_name}</h4>
            <p class="text-cyan-700 mb-2">Kapasitas Maksimum: ${boat.max_capacity} orang</p>
            <label class="font-semibold text-cyan-900 mb-1">Pilih Tujuan:</label>
            <select class="mb-4 w-full border border-cyan-300 rounded-md px-3 py-2">
              ${boat.destinations.map(d => `<option>${d.name} - Rp ${d.price}</option>`).join("")}
            </select>
            <button class="chat-btn mt-auto inline-flex items-center justify-center bg-cyan-600 hover:bg-cyan-700 text-white font-semibold px-4 py-2 rounded-md shadow-md transition"
                    data-wa="https://wa.me/${boat.contact_info.replace(/\D/g, "")}">
              <i class="fab fa-whatsapp mr-2"></i> Chat via WhatsApp
            </button>
          </div>
          <button class="absolute top-2 right-2 text-red-600 hover:text-red-800 bg-red-100 rounded-full p-1 shadow-md transition delete-btn" data-id="${boat.id}">
            <i class="fas fa-trash-alt"></i>
          </button>
        `;

        boatsContainer.appendChild(boatCard);
      });

      attachChatHandlers();
      attachDeleteHandlers();
    }

    // Chat popup
    const popupForm = document.getElementById("popupForm");
    const customerForm = document.getElementById("customerForm");
    const skipBtn = document.getElementById("skipBtn");

    function attachChatHandlers() {
      document.querySelectorAll(".chat-btn").forEach(btn => {
        btn.onclick = () => {
          popupForm.dataset.wa = btn.dataset.wa;
          popupForm.classList.remove("hidden");
          popupForm.classList.add("flex");
        };
      });
    }

    skipBtn.addEventListener("click", () => {
      window.open(popupForm.dataset.wa, "_blank");
      popupForm.classList.add("hidden");
    });

    customerForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(customerForm));

   try {
        const response = await fetch("https://script.google.com/macros/s/AKfycbwRrTZoIM8F70MnnjFm6M7LqcrSh9MszEZ5Ron3fprO3V_tIYJXdSKVTmq-MLv1sZW1/exec", {
          method: "POST",
          body: JSON.stringify(data),
         
        });
    console.log("Data sent to Google Sheets:", data);
  } catch (err) {
    console.error("Failed to send to Google Sheets:", err);
  }

  popupForm.classList.add("hidden");
  window.open(popupForm.dataset.wa, "_blank");
  customerForm.reset();
});


    // Delete handler
    function attachDeleteHandlers() {
      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.onclick = async () => {
          if (confirm("Hapus perahu ini?")) {
            const { error } = await supabase.from("boats").delete().eq("id", btn.dataset.id);
            if (error) alert("Gagal hapus: " + error.message);
            else loadBoats();
          }
        };
      });
    }

    loadBoats();
  </script>
</body>
</html>
